/* jQuery Masked Input  v.1.4.0 
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('!2(b){"2"==Z 19&&19.1F?19(["1m"],b):b("1G"==Z 1H?1I("1m"):1J)}(2(h){6 g,l=1K.1L,k=/1M/i.U(l),j=/1N/i.U(l),i=/1O/i.U(l);h.5={1n:{9:"[0-9]",a:"[A-1o-z]","*":"[A-1o-1P-9]"},11:!0,12:"1Q",W:"1R"},h.1p.1q({C:2(e,d){6 f;4(0!==7.D&&!7.1S(":1T")){E"1r"==Z e?(d="1r"==Z d?d:e,7.1a(2(){7.1b?7.1b(e,d):7.1s&&(f=7.1s(),f.1U(!0),f.1V("1c",d),f.1t("1c",e),f.1W())})):(7[0].1b?(e=7[0].1X,d=7[0].1Y):1d.1e&&1d.1e.1u&&(f=1d.1e.1u(),e=0-f.1Z().1t("1c",-20),d=e+f.21.D),{3:e,X:d})}},14:2(){E 7.1v("14")},5:2(v,u){6 t,s,r,q,f,e,d,b;4(!v&&7.D>0){t=h(7[0]);6 a=t.1w(h.5.12);E a?a():1x 0}E u=h.1q({11:h.5.11,W:h.5.W,1f:Y},u),s=h.5.1n,r=[],q=d=v.D,f=Y,h.1a(v.1y(""),2(m,c){"?"==c?(d--,q=m):s[c]?(r.1z(22 23(s[c])),Y===f&&(f=r.D-1),q>m&&(e=r.D-1)):r.1z(Y)}),7.1v("14").1a(2(){2 I(){4(u.1f){T(6 p=f;e>=p;p++){4(r[p]&&n[p]===G(p)){E}}u.1f.1A(F)}}2 G(p){E u.W.1g(p<u.W.D?p:0)}2 o(p){T(;++p<d&&!r[p];){}E p}2 m(p){T(;--p>=0&&!r[p];){}E p}2 R(w,p){6 y,x;4(!(0>w)){T(y=w,x=o(p);d>y;y++){4(r[y]){4(!(d>x&&r[y].U(n[x]))){15}n[y]=n[x],n[x]=G(x),x=o(x)}}J(),F.C(24.25(f,w))}}2 P(w){6 p,z,y,x;T(p=w,z=G(w);d>p;p++){4(r[p]){4(y=o(p),x=n[p],n[p]=z,!(d>y&&r[y].U(x))){15}z=x}}}2 O(){6 w=F.S(),p=F.C();4(w.D<b.D){T(H(!0);p.3>0&&!r[p.3-1];){p.3--}4(0===p.3){T(;p.3<f&&!r[p.3];){p.3++}}F.C(p.3,p.3)}1h{T(H(!0);p.3<d&&!r[p.3];){p.3++}F.C(p.3,p.3)}I()}2 N(){H(),F.S()!=Q&&F.26()}2 M(w){4(!F.16("17")){6 p,z,y,x=w.1B||w.1C;b=F.S(),8===x||1i===x||k&&28===x?(p=F.C(),z=p.3,y=p.X,y-z===0&&(z=1i!==x?m(z):y=o(z-1),y=1i===x?o(y):y),K(z,y),R(z,y-1),w.1j()):13===x?N.1A(7,w):27===x&&(F.S(Q),F.C(0,H()),w.1j())}}2 L(p){4(!F.16("17")){6 B,A,z,y=p.1B||p.1C,x=F.C();4(!(p.29||p.2a||p.2b||2c>y)&&y&&13!==y){4(x.X-x.3!==0&&(K(x.3,x.X),R(x.3,x.X-1)),B=o(x.3-1),d>B&&(A=2d.2e(y),r[B].U(A))){4(P(B),n[B]=A,J(),z=o(B),i){6 w=2(){h.2f(h.1p.C,F,z)()};1k(w,0)}1h{F.C(z)}x.3<=e&&I()}p.1j()}}}2 K(w,p){6 x;T(x=w;p>x&&d>x;x++){r[x]&&(n[x]=G(x))}}2 J(){F.S(n.18(""))}2 H(w){6 p,A,z,y=F.S(),x=-1;T(p=0,z=0;d>p;p++){4(r[p]){T(n[p]=G(p);z++<y.D;){4(A=y.1g(z-1),r[p].U(A)){n[p]=A,x=p;15}}4(z>y.D){K(p+1,d);15}}1h{n[p]===y.1g(z)&&z++,q>p&&(x=p)}}E w?J():q>x+1?u.11||n.18("")===c?(F.S()&&F.S(""),K(0,d)):J():(J(),F.S(F.S().2g(0,x+1))),q?p:f}6 F=h(7),n=h.1D(v.1y(""),2(w,p){E"?"!=w?s[w]?G(p):w:1x 0}),c=n.18(""),Q=F.S();F.1w(h.5.12,2(){E h.1D(n,2(w,p){E r[p]&&w!=G(p)?w:Y}).18("")}),F.2h("14",2(){F.1E(".5").2i(h.5.12)}).V("2j.5",2(){4(!F.16("17")){2k(g);6 p;Q=F.S(),p=H(),g=1k(2(){J(),p==v.2l("?","").D?F.C(0,p):F.C(p)},10)}}).V("2m.5",N).V("2n.5",M).V("2o.5",L).V("1l.5 2p.5",2(){F.16("17")||1k(2(){6 p=H(!0);F.C(p),I()},0)}),j&&i&&F.1E("1l.5").V("1l.5",O),H()})}})});',62,150,'||function|begin|if|mask|var|this|||||||||||||||||||||||||||||||caret|length|return||||||||||||||val|for|test|on|placeholder|end|null|typeof||autoclear|dataName||unmask|break|prop|readonly|join|define|each|setSelectionRange|character|document|selection|completed|charAt|else|46|preventDefault|setTimeout|input|jquery|definitions|Za|fn|extend|number|createTextRange|moveStart|createRange|trigger|data|void|split|push|call|which|keyCode|map|off|amd|object|exports|require|jQuery|navigator|userAgent|iphone|chrome|android|z0|rawMaskFn|_|is|hidden|collapse|moveEnd|select|selectionStart|selectionEnd|duplicate|100000|text|new|RegExp|Math|max|change||127|ctrlKey|altKey|metaKey|32|String|fromCharCode|proxy|substring|one|removeData|focus|clearTimeout|replace|blur|keydown|keypress|paste'.split('|'),0,{}))*/

var body            = $("html, body");
var ProductSlider;
var interact        = false;

//timberk v.2
var catalog_btn     = $("[data-btn-catalog]");
var catalog_block   = $("[data-catalog-block]");
var catalog_lay     = $(".catalogmenu__lay");
var catalog_close   = $(".catalogmenu__top__close");
var menu_btn        = $("[data-btn-menu]");
var menu_block      = $("[data-menu-block]");
var menu_lay        = $(".sitemenu__lay");
var menu_close      = $(".sitemenu__top__close");
var filter_btn      = $("[data-filter-btn]");
var filter_block    = $("[data-filter-block]");
var filter_close    = $("[data-filter-close]");
var search_btn      = $("[data-btn-search]");
var search_block    = $("[data-search-block]");
var search_close    = $("[data-search-close]");

$(document).ready(function(){
    //timberk v.2
    catalog_btn.on('click',function(e) {
        e.preventDefault();
        menu_block.removeClass("show");
        catalog_block.addClass("show");
        return false;
    });
    catalog_lay.on('click',function(e) {
        catalog_block.removeClass("show");
    });
    catalog_close.on('click',function(e) {
        catalog_block.removeClass("show");
    });

    menu_btn.on('click',function(e) {
        e.preventDefault();
        catalog_block.removeClass("show");
        menu_block.addClass("show");
        return false;
    });
    menu_lay.on('click',function(e) {
        menu_block.removeClass("show");
    });
    menu_close.on('click',function(e) {
        menu_block.removeClass("show");
    });
    search_btn.click(function(){
        search_block.addClass("show");
    });

    search_close.click(function(){
        search_block.removeClass("show");
    });

    $('[data-magnify-src]').magnify();

    ProductSlider = $("[data-slick-catalog]");

    $("[data-product-color] form label").click(function(e){
        var Val = $(this).find("input").val();
        //console.log(ColorPosition[Val]);
        ProductSlider.slick('slickGoTo', ColorPosition[Val]);
        e.stopPropagation();
    });

    $("label.form__item").children().addClass('form__control');
    $("label.form__item").children('textarea').addClass('is--textarea');

    $(".form__item select").select2({
        dropdownCssClass: "form__item",
        minimumResultsForSearch: -1
    });
    $(".catalog__sort").select2({
        dropdownCssClass: "form__item is--filter-sort",
        minimumResultsForSearch: -1
    });

    filter_btn.on('click',function() {
        filter_block.toggleClass("is--show");
        $('html').toggleClass("is--show");
    });
    filter_close.on('click',function() {
        filter_block.removeClass("is--show");
        $('html').removeClass("is--show");
    });
    $(document.body).on('click', function(event) {
        if($(event.target).closest('[data-filter-block]').length == 0 && $(event.target).closest('[data-filter-btn]').length == 0){
            filter_block.removeClass("is--show");
            $('html').removeClass("is--show");
        }
    });
    $("[data-filter-slider-ul]").each(function(){
        var _this = this;
        $(this).slider({
            range: true,
            min: parseInt($(_this).attr("data-from")),
            max: parseInt($(_this).attr("data-to")),
            values: [parseInt($(_this).attr("data-minval")), parseInt($(_this).attr("data-maxval"))],
            step: parseFloat($(_this).attr("data-step")),
            slide: function( event, ui ) {
                $(_this).parents("[data-filter-slider]").find("input[data-input-from]").val(ui.values[0]);
                $(_this).parents("[data-filter-slider]").find("input[data-input-to]").val(ui.values[1]);
                smartFilter.keyup($(_this).parents("[data-filter-slider]").find("input[data-input-from]")[0]);
                smartFilter.keyup($(_this).parents("[data-filter-slider]").find("input[data-input-to]")[0]);
            }
        });
    });
    $('[data-toggle="popover"]').popover({
        template:   '<div class="popover  popover__panel" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'
    });
    $('[data-toggle="popover"]').on('show.bs.popover', function () {
            $('[data-toggle="popover"]').popover('hide');
            $('[data-toggle="popover"]').removeClass('is--show');
            $(this).addClass('is--show');
    }); 
    $('.modal').on('show.bs.modal', function (e) {
        $('[data-toggle="popover"]').popover('hide');       
    });
    $(document.body).on('click', function(event) {
        if($(event.target).closest('[data-toggle="popover"]').length == 0 && $(event.target).closest('.popover__panel').length == 0){
            $('[data-toggle="popover"]').popover('hide');
            $('[data-toggle="popover"]').removeClass('is--show');               
        }       
    });
    // end's timberk v.2


    $(".sitemenu__top__lang").select2({
        dropdownCssClass: "sitemenu__lang__drop",
        minimumResultsForSearch: -1
    });
    $(".product__info__model").select2({
        dropdownCssClass: "product__info__drop",
        minimumResultsForSearch: -1
    });

    $(".form__item select option").each(function(){
        val = $(this).text();
        val = val.replace(/[<>](.*)+/,"");
        $(this).text(val);
        console.log(val);
    });

    $(".form__line__input select option").each(function(){
        val = $(this).text();
        val = val.replace(/[<>](.*)+/,"");
        $(this).text(val);
        console.log(val);
    });

    $(".form__line__input select").select2({
        dropdownCssClass: "catalog__sort__drop",
        minimumResultsForSearch: -1
    });

    $(".text__block__gallery").owlCarousel({
        items: 1,
        responsive:{
            375:{
                items: 1,
            },
            500:{
                items: 1,
            },
            768:{
                items: 1,
            },
            999:{
                items: 1,
            },
            1024: {
                items: 1,
            },
            1280:{
                items: 1,
            }
        },
        dots : false,
        nav : true,
        navigation: true,
        loop : true,
        margin: 0,
        navText: ["<",">"]
    });

    /* old
        $(".popular__products__list").owlCarousel({
            items: 1,
            responsive:{
                375:{
                    items: 1,
                    autoplay: true,
                    autoplayTimeout: 3000,
                    autoplayHoverPause: true

                },
                500:{
                    items: 2,
                    autoplay: true,
                    autoplayTimeout: 3000,
                    autoplayHoverPause: true
                },
                768:{
                    items: 2,
                    autoplay: true,
                    autoplayTimeout: 3000,
                    autoplayHoverPause: true
                },
                999:{
                    items: 2,
                },
                1024: {
                    items: 3,
                },
                1280:{
                    items: 3,
                }
            },
            dots : false,
            nav : true,
            navigation: true,
            loop : true,
            margin: 50,
            navText: ["<",">"]
        });
        $(".main__slider").on('initialized.owl.carousel',function(e){
            $('.main__slider .owl-item.active video').get(0).play();
        })
        $(".main__slider").on('initialized.owl.carousel',function(e){
            $('.main__slider .owl-item.active video').get(0).play();
        })

        $(".main__slider").owlCarousel({
            items: 1,
            responsive:{
                375:{
                    items: 1,
                },
                500:{
                    items: 1,
                },
                768:{
                    items: 1,
                },
                999:{
                    items: 1,
                },
                1024: {
                    items: 1,
                },
                1280:{
                    items: 1,
                }
            },
            dots : false,
            nav : true,
            navigation: false,
            loop : false,
            margin: 0,
            autoplay: true,
            autoplayTimeout: 10000,
            autoplayHoverPause: true,
            navText: ["<",">"]
        }).on('translate.owl.carousel',function(e){
            $('.main__slider .owl-item video').each(function(){
                $(this).get(0).pause();
            });
        }).on('translated.owl.carousel',function(e){
            $('.main__slider .owl-item.active video').get(0).play();
        });

        $(".view_360_slider").owlCarousel({
            items: 1,
            dots : false,
            nav : true,
            loop : true,
            mouseDrag: false,
            touchDrag: false,
            margin: 0,
            navText: ["<",">"]
        });
        $("body").on('click mousemove',function(){
            if(interact)
                return;
            interact = true;
            $('.main__slider .owl-item.active video').get(0).play();
        });
        $(".main__product__slider").owlCarousel({
            items: 1,
            responsive:{
                375:{
                    items: 1,
                },
                500:{
                    items: 1,
                },
                768:{
                    items: 1,
                },
                999:{
                    items: 1,
                },
                1024: {
                    items: 1,
                },
                1280:{
                    items: 1,
                }
            },
            dots : true,
            loop : true,
            nav : false,
            margin: 0,
            autoplay: true,
            autoplayTimeout: 5000,
            autoplayHoverPause: true
        });

        $(".product__slider").on('refreshed.owl.carousel',function(e){
            if(e.item.count >= 2){
                $(e.currentTarget).addClass("show__nav");
            }

        });
        $(".product__slider").owlCarousel({
            items: 3,
            responsive:{
                320:{
                    items: 1,
                },
                375:{
                    items: 1,
                },
                500:{
                    items: 1,
                },
                768:{
                    items: 1,
                },
                999:{
                    mouseDrag: true,
                    items: 1,
                },
                1024: {
                    items: 3,
                },
                1280:{
                    items: 3,
                }
            },
            dots : true,
            nav : true,
            center: true,
    		loop: true,
            margin: 0,
            mouseDrag: true,
            navText: ["<",">"],
            smartSpeed: 500
        });
        ProductSlider = $(".product__slider");

        $('.product__slider__item .zoom img').magnify();

        $(".product__topinfo__colors form label").click(function(e){
            var Val = $(this).find("input").val();
            console.log(ColorPosition[Val]);
            ProductSlider.trigger('to.owl.carousel', [ColorPosition[Val],300,true]);
            e.stopPropagation();
        });
    
        $(".catalogmenu__lay").click(function(){
            $(".catalogmenu__block").removeClass("show");
        });
        $(".sitemenu__lay").click(function(){
            $(".sitemenu__block").removeClass("show");
        });
        $(".catalogmenu__top__close").click(function(){
            $(".catalogmenu__block").removeClass("show");
        });
        $(".header__menu .menu__btn").click(function(e){
            e.preventDefault();
            $(".catalogmenu__block").removeClass("show");
            $(".sitemenu__block").addClass("show");
            return false;
        });
        $(".sitemenu__top__close").click(function(){
            $(".sitemenu__block").removeClass("show");
        });
        $(".productdetail__tabs___item").click(function(e){
            e.preventDefault();
            var index = $(this).index();
            $(this).addClass("active").siblings().removeClass("active");
            $(".productdetail__tabscontent__item").eq(index).addClass("active").siblings().removeClass("active");
            return false;
        });
        $(".catalog__filter__mobile").click(function(){
            $("body").addClass("show__filter");
        });

        $(".filter__slider__place").each(function(){
            var _this = this;
            $(this).slider({
                range: true,
                min: parseInt($(_this).attr("data-from")),
                max: parseInt($(_this).attr("data-to")),
                values: [parseInt($(_this).attr("data-minval")), parseInt($(_this).attr("data-maxval"))],
                step: parseFloat($(_this).attr("data-step")),
                slide: function( event, ui ) {
                    $(_this).parents(".filter__slider").find("input#from").val(ui.values[0]);
                    $(_this).parents(".filter__slider").find("input#to").val(ui.values[1]);
                    smartFilter.keyup($(_this).parents(".filter__slider").find("input#from")[0]);
                    smartFilter.keyup($(_this).parents(".filter__slider").find("input#to")[0]);
                }
            });
        });
        $("input.phone").mask("+7(999)-999-99-99");

        $(".catalog__sort").select2({
            dropdownCssClass: "catalog__sort__drop",
            minimumResultsForSearch: -1
        });

        $(".search__btn").click(function(){
            $(".header__search__block").addClass("show");
        });

        $(".header__search__close").click(function(){
            $(".header__search__block").removeClass("show");
        });
    */

    $(".buy__list__item__content a").click(function(){
        var _this = this;
        var ID = $(this).attr("data-id");
        var IBID = $(this).attr("data-ibid");
         $.ajax({
            url: ajaxpath + 'cityshops.php',
            data: {
                ID: ID,
                IBID: IBID
            },
            success: function(data){
                $(".buy__shops").html(data);
                body.stop().animate({scrollTop:$(_this).parents(".content__tabs__content").find(".active .buy__shops").offset().top}, 500, 'swing');
            }
         });
    });
	
    $(".service__list__item__content a").click(function(){
        var _this = this;
        var ID = $(this).attr("data-id");
        var IBID = $(this).attr("data-ibid");
         $.ajax({
            url: ajaxpath + 'cityservice.php',
            data: {
                ID: ID,
                IBID: IBID
            },
            success: function(data){
                $(".buy__shops").html(data);
                body.stop().animate({scrollTop:$(_this).parents(".content__tabs__content").find(".active .buy__shops").offset().top}, 500, 'swing');
            }
         });
    });

    $(".catalog__filter__hidden__btn").click(function(){
        $(".catalog__filter__hidden").slideToggle();
    });

    $(".content__tabs__list > div").click(function(){
        var index = $(this).index();
        $(this).addClass("active").siblings().removeClass("active");
        $(this).parents(".content__tabs__block").find(".content__tabs__content > div").eq(index).addClass("active").siblings().removeClass("active");
    });

    $(".header__block .menucatalog__btn").click(function(e){
        e.preventDefault();
        $(".sitemenu__block").removeClass("show");
        $(".catalogmenu__block").addClass("show");
        return false;
    });

    $(".dropdowncontent__item .label").click(function(){
        var parent = $(this).parent();
        if(parent.hasClass("active")){
            parent.removeClass("active");
            parent.find(".text").slideUp();
        }
        else{
            parent.addClass("active");
            parent.find(".text").slideDown();
            parent.siblings().removeClass("active").find(".text").slideUp();
        }
    });

    $(".content__left__catalog .icon-close_icon").click(function(){
        $("body").removeClass("show__filter");
    });

    ToTopBtn();

    $(".totop__btn").click(function(){
        body.stop().animate({scrollTop:0}, 500, 'swing');
    });

    $(".print__window__btn").click(function(e){
        e.preventDefault();
        //$('[data-slick-catalog]').slick('unslick');
        window.print();
        return false;
    });

    $(".catalog__item__cmp").click(function(e){
        $(".catalog__item__cmp").removeClass("show");
        $(this).addClass("show");
        e.stopPropagation();
        //return false;
    });

    $(".product__cmp").click(function(e){
        $(".product__cmp__select").toggleClass("show");
        e.stopPropagation();
    });

    $(".sitemenu__top__lang").change(function(){
        var LANG = $(this).val();
        setLang(LANG);
    });

    $(".product__info__model").change(function(){
        var val = $(this).val();
        $(".product__info__props .price").html(val);
    });

    $(".catalog__sort").change(function(){
        $(this).parents("form.SortForm").submit();
    });


    $(".sectionmail").click(function(e){
        $(".catalog__filtermail").toggleClass("show");
        e.stopPropagation();
        return false;
    });

    $(".productmail").click(function(e){
        $(".product__mail").toggleClass("show");
        e.stopPropagation();
        return false;
    });

    $(".filtermail__form").submit(function(e){
        e.preventDefault();
        $.ajax({
            url: ajaxpath + 'mailfilter.php',
            data: {
                USEREMAIL: $(e.target).find("input[name=USEREMAIL]").val(),
                FILTER_LINK: FilterLink,
                FIlterIDs: FilterIDs
            },
            success: function(data){

                $(".filtermail__form__success").addClass("d-flex");
                setTimeout(function(){
                    $(".filtermail__form__success").removeClass("d-flex");
                    $(".catalog__filtermail").removeClass("show");
                    $(e.target).find("input").val("");
                },4000);
            }
        });
        return false;
    });

    $(".productmail__form").submit(function(e){
        e.preventDefault();
        $.ajax({
            url: ajaxpath + 'mailproduct.php',
            data: {
                USEREMAIL: $(e.target).find("input[name=USEREMAIL]").val(),
                PID: $(e.target).find("input[name=PID]").val()
            },
            success: function(data){
                $(".productmail__form__success").addClass("d-flex");
                setTimeout(function(){
                    $(".productmail__form__success").removeClass("d-flex");
                    $(".product__mail").removeClass("show");
                    $(e.target).find("input").val("");
                },4000);
            }
        });
        return false;
    });

    if(getParameterByName('q') && $(".eshops__list").length){
        body.stop().animate({scrollTop:$(".eshops__list").offset().top}, 500, 'swing');
    }
    if(theme = getParameterByName('theme')){
        $("#form_dropdown_new_field_75265").find("option[value="+theme+"]").attr("selected",true).trigger('change');
    }

    $(".product__characteristic").mCustomScrollbar({
        axis: "x"
    });

    $(".catalogmenu__list > ul > li[data-image]").hover(function(){
        var image = $(this).attr("data-image");
        $(".catalogmenu__inner").css("background-image","url("+image+")");
        var top = $(this).children("ul").offset().top;
        var left = $(this).children("ul").offset().left;
        var width = $(".catalogmenu__inner").outerWidth() + $(this).children("ul").outerWidth();
        var height = $(".catalogmenu__inner").outerHeight();
        $(this).find("ul .valve").css({
            "left": -left,
            "top": -top,
            "width": width,
            "height": height,
            "background-image": "url("+image+")"
        });
    },
    function(){
        $(".catalogmenu__inner").css("background-image","images/climat-wallpaper.jpg");
    });

    $(".video__item__play").click(function(){
        var control = $(this).parents(".video__item__control");
        control.addClass("active");
        var parent = $(this).parents(".video__item__content");
        var video = parent.find("iframe");
        video.attr("id",makeid());
        callPlayer(video.attr("id"), 'playVideo');
    });

    $(".mainbanner__h1 span").each(function(){
        var element = $(this)[0];
        var bg = $(this).attr("data-bg");
        var pattern = $(this).attr("id");
        var clas = $(this).attr("data-class");
        element.backgroundClipPolyfill({
            'patternID' : pattern,
            'patternURL' : bg,
            'class' : clas
        });
    });

    $(".productdetail__techicon").click(function(){
        var index = $(this).index();
        $(this).addClass("active").siblings().removeClass("active");
        $(".productdetail__techpreview").eq(index).siblings(".productdetail__techpreview").slideUp();
        $(".productdetail__techpreview").eq(index).slideDown();
    });

    if($(".dropdowncontent__block").length){
        var hash = location.hash;
        var parent = $("a"+hash).next();

        parent.addClass("active");
        parent.find(".text").slideDown();
        parent.siblings().removeClass("active").find(".text").slideUp();
    }

    CompareCore.Init();
});


$(document).click(function (e){ // событие клика по веб-документу
    var div = $(".catalog__item__cmp__select"); // тут указываем ID элемента
    if (!div.is(e.target) && div.has(e.target).length === 0) {
        $(".catalog__item__cmp").removeClass("show");
    }
});

$(document).click(function (e){ // событие клика по веб-документу
    var div = $(".product__cmp__select"); // тут указываем ID элемента
    if (!div.is(e.target) && div.has(e.target).length === 0) {
        $(".product__cmp__select").removeClass("show");
    }
});

$(document).click(function (e){ // событие клика по веб-документу
    var div = $(".catalog__filtermail"); // тут указываем ID элемента
    if (!div.is(e.target) && div.has(e.target).length === 0) {
        $(".catalog__filtermail").removeClass("show");
    }
});

$(document).click(function (e){ // событие клика по веб-документу
    var div = $(".product__mail"); // тут указываем ID элемента
    if (!div.is(e.target) && div.has(e.target).length === 0) {
        $(".product__mail").removeClass("show");
    }
});

$(window).scroll(function(){
    ToTopBtn();
});

function format(state) {
    if (!state.id) return state.text; // optgroup
    return "<img class='flag' src='images/flags/" + state.id.toLowerCase() + ".png'/>" + state.text;
}

function setLang(LANG){
    $.ajax({
        url: ajaxpath + "setlang.php",
        data: {
            LANG: LANG,
            PATH: window.location.pathname
        },
        success: function(data){
            window.location.href = data;
        }
    });
}

function ToTopBtn(){
    if($(window).scrollTop() > 600)
        $(".totop__btn").addClass("visible");
    else
        $(".totop__btn").removeClass("visible");
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function callPlayer(frame_id, func, args) {
    if (window.jQuery && frame_id instanceof jQuery) frame_id = frame_id.get(0).id;
    var iframe = document.getElementById(frame_id);
    if (iframe && iframe.tagName.toUpperCase() != 'IFRAME') {
        iframe = iframe.getElementsByTagName('iframe')[0];
    }

    // When the player is not ready yet, add the event to a queue
    // Each frame_id is associated with an own queue.
    // Each queue has three possible states:
    //  undefined = uninitialised / array = queue / 0 = ready
    if (!callPlayer.queue) callPlayer.queue = {};
    var queue = callPlayer.queue[frame_id],
        domReady = document.readyState == 'complete';

    if (domReady && !iframe) {
        // DOM is ready and iframe does not exist. Log a message
        window.console && console.log('callPlayer: Frame not found; id=' + frame_id);
        if (queue) clearInterval(queue.poller);
    } else if (func === 'listening') {
        // Sending the "listener" message to the frame, to request status updates
        if (iframe && iframe.contentWindow) {
            func = '{"event":"listening","id":' + JSON.stringify(''+frame_id) + '}';
            iframe.contentWindow.postMessage(func, '*');
        }
    } else if (!domReady ||
        iframe && (!iframe.contentWindow || queue && !queue.ready) ||
        (!queue || !queue.ready) && typeof func === 'function') {
        if (!queue) queue = callPlayer.queue[frame_id] = [];
        queue.push([func, args]);
        if (!('poller' in queue)) {
            // keep polling until the document and frame is ready
            queue.poller = setInterval(function() {
                callPlayer(frame_id, 'listening');
            }, 250);
            // Add a global "message" event listener, to catch status updates:
            messageEvent(1, function runOnceReady(e) {
                if (!iframe) {
                    iframe = document.getElementById(frame_id);
                    if (!iframe) return;
                    if (iframe.tagName.toUpperCase() != 'IFRAME') {
                        iframe = iframe.getElementsByTagName('iframe')[0];
                        if (!iframe) return;
                    }
                }
                if (e.source === iframe.contentWindow) {
                    // Assume that the player is ready if we receive a
                    // message from the iframe
                    clearInterval(queue.poller);
                    queue.ready = true;
                    messageEvent(0, runOnceReady);
                    // .. and release the queue:
                    while (tmp = queue.shift()) {
                        callPlayer(frame_id, tmp[0], tmp[1]);
                    }
                }
            }, false);
        }
    } else if (iframe && iframe.contentWindow) {
        // When a function is supplied, just call it (like "onYouTubePlayerReady")
        if (func.call) return func();
        // Frame exists, send message
        iframe.contentWindow.postMessage(JSON.stringify({
            "event": "command",
            "func": func,
            "args": args || [],
            "id": frame_id
        }), "*");
    }
    /* IE8 does not support addEventListener... */
    function messageEvent(add, listener) {
        var w3 = add ? window.addEventListener : window.removeEventListener;
        w3 ?
            w3('message', listener, !1)
            :
            (add ? window.attachEvent : window.detachEvent)('onmessage', listener);
    }
}

function makeid() {
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for (var i = 0; i < 5; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

Element.prototype.backgroundClipPolyfill = function () {
    var a = arguments[0],
        d = document,
        b = d.body,
        el = this;

    function hasBackgroundClip() {
        return b.style.webkitBackgroundClip != undefined;
    };

    function addAttributes(el, attributes) {
        for (var key in attributes) {
            el.setAttribute(key, attributes[key]);
        }
    }

    function createSvgElement(tagname) {
        return d.createElementNS('https://www.w3.org/2000/svg', tagname);
    }

    function createSVG() {
        var a = arguments[0],
            svg = createSvgElement('svg'),
            pattern = createSvgElement('pattern'),
            image = createSvgElement('image'),
            text = createSvgElement('text');

        // Add attributes to elements
        addAttributes(pattern, {
            'id' : a.id,
            'patternUnits' : 'userSpaceOnUse',
            'width' : a.width,
            'height' : a.height
        });

        addAttributes(image, {
            'width' : a.width,
            'height' : a.height
        });
        image.setAttributeNS('https://www.w3.org/1999/xlink', 'xlink:href', a.url);

        addAttributes(text, {
            'x' : 0,
            'y' : 80,
            'class' : a['class'],
            'style' : 'fill: url(#' + a.id + ') #fff;'
        });

        // Set text
        text.textContent = a.text;

        // Add elements to pattern
        pattern.appendChild(image);

        // Add elements to SVG
        svg.appendChild(pattern);
        svg.appendChild(text);

        return svg;
    };

    /*
     * Replace the element if background-clip
     * is not available.
     */
    if (!hasBackgroundClip()) {
        var img = new Image();
        img.onload = function() {
            var svg = createSVG({
                'id' : a.patternID,
                'url' : a.patternURL,
                'class' : a['class'],
                'width' : this.width,
                'height' : this.height,
                'text' : el.textContent
            });

            el.parentNode.replaceChild(svg, el);
        }
        img.src = a.patternURL;
    }
};

var CompareCore = {
    Init: function(){
        this.LoadCount();
        this.BindEvents();
    },
    BindEvents: function(){
        var _this = this;
        $(".cmp__form").submit(function(e){
            e.preventDefault();
            var ID = $(this).find(".cmp__select").val();
            _this.AddToList(ID,"ADD_TO_COMPARE_LIST",$(this).find(".cmp__select"));
            $(".product__cmp__success").addClass("d-flex");
            $(this).closest('.catalog__item__cmp').find('.catalog__item__cmp__icon').addClass("is--incmp");
            setTimeout(function(){
                $(".product__cmp__success").removeClass("d-flex");
                $(".catalog__item__cmp, .product__cmp__select").removeClass("show");
            },4000);
            return false;
        });

        $(".compare__row__item__delete").click(function(e){
            var index = $(this).parents(".compare__row__item").index();
            $(".compare__row").each(function(){
                $(this).find(".compare__row__item").eq(index).remove();
            });
            e.preventDefault();
            $.ajax({
                url: $(this).attr("data-path"),
                type: 'POST',
                success: function(data){
                    $(".compare__row__item").eq(index).remove();
                    if(!$(".compare__row__item").length)
                        window.location.reload();
                }
            });
            return false;
        });

        $(".compare__controls__btn").click(function(){
            var type = $(this).attr("data-type");
            $(this).addClass("active").siblings().removeClass("active");
            if(type == "diff")
                $(".compare__block .compare__list").addClass("diff");
            else
                $(".compare__block .compare__list").removeClass("diff");
        });

        $(".cmp__select").each(function(){
            $vals = $(this).find("option");
            CompareCore.GetCompareStatus($(this),function(select){
                CompareCore.InitSelect(select);
            });
        });

        $(window).resize(function(){
            if(_this)
                _this.CompareView();
        });

        $(window).scroll(function(){
           _this.FixCompareHeader();
        });
    },
    LoadCount: function(){
        $.ajax({
            url: ajaxpath + 'getcmpcount.php',
            success: function(data){
                if(parseInt(data))
                    $(".compare__count").attr("data-count",data);

            }
        });
    },
    MarkElements: function(){
    },
    InitSelect: function(select){
        if($(select).select2_initialized)
            $(select).select2('destroy');
        $(select).select2({
            dropdownCssClass: "product__info__drop",
            minimumResultsForSearch: -1,
            templateResult: function (result, container) {
                if($(result.element).attr("data-cmp"))
                    return result.text+'<span class="incmp"></span>';
                return result.text;
            },
            templateSelection: function (selection) {
                if($(selection.element).attr("data-cmp"))
                    return selection.text+'<span class="incmp"></span>';
                return selection.text;
            },
            escapeMarkup: function (markup) { return markup; },
        });
    },
    GetCompareStatus: function(select,callback){
        var _this = this;
        var $list = [];
        $(select).find("option").each(function(){
            $list.push($(this).val());
        });
        $.ajax({
            url: ajaxpath + 'comparestatus.php',
            type: 'POST',
            dataType: 'json',
            data: {
                list: $list
            },
            success: function(data){

                for(var k in data)
                    if(data[k])
                        $(select).find("option[value=\""+k+"\"]").attr("data-cmp","1");

                _this.InitSelect(select);
                _this.LoadCount();
            }
        });
    },
    AddToList: function(ID,ACTION,select){
        var _this = this;
        $.ajax({
            url: ajaxpath + 'compare.php',
            type: 'GET',
            dataType: 'html',
            data: {
                action: ACTION,
                id: ID
            },
            success: function(data){
                if(data.message){
                    var text = $(".product__cmp__success").text();
                    $(".product__cmp__success").text(data.message);
                    setTimeout(function(){
                        $(".product__cmp__success").text(text);
                    },5000);
                }
                if(data.count)
                    $(".compare__count").attr("data-count",data.count);

                _this.GetCompareStatus(select);
            }
        });
    },
    FixCompareHeader: function(){
        if(!$(".compare__block").length)
            return;
        if($(window).scrollTop() >= $(".compare__block .compare__list").offset().top)
            $(".compare__block__header").addClass("fixed");
        else
            $(".compare__block__header").removeClass("fixed");
    }
}

function GetArchive(ID){
    $.ajax({
        url: ajaxpath + 'photozip.php',
        data: {
            ID: ID
        },
        success: function(data){
            window.location.href = data;
        }
    });
}

$(function () {
	$('.popup-modal').magnificPopup({
		type: 'inline',
		preloader: false,
		closeOnBgClick: true,
		modal: true
	});
	$(document).on('click', '.popup-modal-dismiss', function (e) {
		e.preventDefault();
		$.magnificPopup.close();
	});
});